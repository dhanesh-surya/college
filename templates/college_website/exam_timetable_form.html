{% extends 'base.html' %}
{% load static %}

{% block title %}{{ action }} Exam Timetable - {{ college_info.college_name }}{% endblock %}

{% block content %}
<!-- Header Section -->
<section class="hero-section tw-bg-gradient-to-r tw-from-blue-500 tw-to-indigo-600 tw-py-12">
    <div class="container">
        <div class="row tw-justify-center text-center">
            <div class="col-lg-8">
                <h1 class="tw-text-3xl tw-font-bold tw-text-white tw-mb-3">{{ action }} Exam Timetable</h1>
                <p class="tw-text-lg tw-text-blue-100 tw-mb-4">Configure timetable settings and appearance</p>
                <div class="tw-flex tw-flex-wrap tw-justify-center tw-gap-3">
                    <a href="{% url 'college_website:exam_timetable_manage' %}" class="btn btn-outline-light tw-rounded-full tw-px-6 tw-py-2">
                        <i class="fas fa-arrow-left tw-mr-2"></i>Back to Management
                    </a>
                    {% if timetable %}
                        <a href="{% url 'college_website:exam_timetable_week_manage' timetable.id %}" class="btn btn-light tw-rounded-full tw-px-6 tw-py-2">
                            <i class="fas fa-calendar-week tw-mr-2"></i>Manage Weeks
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Form Section -->
<section class="form-section tw-py-8">
    <div class="container">
        <div class="row tw-justify-center">
            <div class="col-lg-10">
                <div class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-border tw-border-gray-200">
                    <div class="tw-p-6 tw-border-b tw-border-gray-200">
                        <h3 class="tw-text-xl tw-font-bold tw-text-gray-800 tw-mb-0">Timetable Configuration</h3>
                    </div>
                    
                    <div class="tw-p-6">
                        <form method="post" class="needs-validation" novalidate>
                            {% csrf_token %}
                            
                            <!-- Basic Information -->
                            <div class="tw-mb-6">
                                <h4 class="tw-text-lg tw-font-semibold tw-text-gray-800 tw-mb-4 tw-pb-2 tw-border-b tw-border-gray-200">
                                    <i class="fas fa-info-circle tw-mr-2 tw-text-blue-500"></i>Basic Information
                                </h4>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label tw-font-medium tw-text-gray-700">
                                            Timetable Name <span class="tw-text-red-500">*</span>
                                        </label>
                                        {{ form.name }}
                                        {% if form.name.errors %}
                                            <div class="invalid-feedback tw-text-red-500 tw-text-sm">
                                                {{ form.name.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label tw-font-medium tw-text-gray-700">
                                            Academic Year <span class="tw-text-red-500">*</span>
                                        </label>
                                        {{ form.academic_year }}
                                        {% if form.academic_year.errors %}
                                            <div class="invalid-feedback tw-text-red-500 tw-text-sm">
                                                {{ form.academic_year.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label tw-font-medium tw-text-gray-700">
                                            Semester <span class="tw-text-red-500">*</span>
                                        </label>
                                        {{ form.semester }}
                                        {% if form.semester.errors %}
                                            <div class="invalid-feedback tw-text-red-500 tw-text-sm">
                                                {{ form.semester.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Header Customization -->
                            <div class="tw-mb-6">
                                <h4 class="tw-text-lg tw-font-semibold tw-text-gray-800 tw-mb-4 tw-pb-2 tw-border-b tw-border-gray-200">
                                    <i class="fas fa-palette tw-mr-2 tw-text-purple-500"></i>Header Customization
                                </h4>
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label class="form-label tw-font-medium tw-text-gray-700">Header Title</label>
                                        {{ form.header_title }}
                                        {% if form.header_title.errors %}
                                            <div class="invalid-feedback tw-text-red-500 tw-text-sm">
                                                {{ form.header_title.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label tw-font-medium tw-text-gray-700">Header Subtitle</label>
                                        {{ form.header_subtitle }}
                                        {% if form.header_subtitle.errors %}
                                            <div class="invalid-feedback tw-text-red-500 tw-text-sm">
                                                {{ form.header_subtitle.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label tw-font-medium tw-text-gray-700">Gradient Start Color</label>
                                        {{ form.header_gradient_start }}
                                        {% if form.header_gradient_start.errors %}
                                            <div class="invalid-feedback tw-text-red-500 tw-text-sm">
                                                {{ form.header_gradient_start.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label tw-font-medium tw-text-gray-700">Gradient End Color</label>
                                        {{ form.header_gradient_end }}
                                        {% if form.header_gradient_end.errors %}
                                            <div class="invalid-feedback tw-text-red-500 tw-text-sm">
                                                {{ form.header_gradient_end.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Session Timing -->
                            <div class="tw-mb-6">
                                <h4 class="tw-text-lg tw-font-semibold tw-text-gray-800 tw-mb-4 tw-pb-2 tw-border-b tw-border-gray-200">
                                    <i class="fas fa-clock tw-mr-2 tw-text-green-500"></i>Session Timing
                                </h4>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label tw-font-medium tw-text-gray-700">Morning Session Start</label>
                                        {{ form.morning_session_start }}
                                        {% if form.morning_session_start.errors %}
                                            <div class="invalid-feedback tw-text-red-500 tw-text-sm">
                                                {{ form.morning_session_start.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label tw-font-medium tw-text-gray-700">Morning Session End</label>
                                        {{ form.morning_session_end }}
                                        {% if form.morning_session_end.errors %}
                                            <div class="invalid-feedback tw-text-red-500 tw-text-sm">
                                                {{ form.morning_session_end.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label tw-font-medium tw-text-gray-700">Afternoon Session Start</label>
                                        {{ form.afternoon_session_start }}
                                        {% if form.afternoon_session_start.errors %}
                                            <div class="invalid-feedback tw-text-red-500 tw-text-sm">
                                                {{ form.afternoon_session_start.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label tw-font-medium tw-text-gray-700">Afternoon Session End</label>
                                        {{ form.afternoon_session_end }}
                                        {% if form.afternoon_session_end.errors %}
                                            <div class="invalid-feedback tw-text-red-500 tw-text-sm">
                                                {{ form.afternoon_session_end.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label tw-font-medium tw-text-gray-700">Break Duration</label>
                                        {{ form.break_duration }}
                                        {% if form.break_duration.errors %}
                                            <div class="invalid-feedback tw-text-red-500 tw-text-sm">
                                                {{ form.break_duration.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Guidelines & Status -->
                            <div class="tw-mb-6">
                                <h4 class="tw-text-lg tw-font-semibold tw-text-gray-800 tw-mb-4 tw-pb-2 tw-border-b tw-border-gray-200">
                                    <i class="fas fa-gavel tw-mr-2 tw-text-orange-500"></i>Guidelines & Status
                                </h4>
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label class="form-label tw-font-medium tw-text-gray-700">Exam Guidelines</label>
                                        {{ form.exam_guidelines }}
                                        {% if form.exam_guidelines.errors %}
                                            <div class="invalid-feedback tw-text-red-500 tw-text-sm">
                                                {{ form.exam_guidelines.errors.0 }}
                                            </div>
                                        {% endif %}
                                        <div class="form-text tw-text-gray-500">Enter exam guidelines, rules, and important information for students.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="enhanced-checkbox admin-compact">
                                            {{ form.is_active }}
                                            <label for="{{ form.is_active.id_for_label }}" class="tw-font-medium tw-text-gray-700">
                                                Active Timetable
                                                <span class="checkbox-status"></span>
                                                <span class="status-text">{{ form.is_active.value|yesno:"Active,Inactive" }}</span>
                                            </label>
                                        </div>
                                        <div class="form-text tw-text-gray-500">Enable this timetable for public viewing</div>
                                        <script>
                                            // Immediate initialization for this checkbox
                                            (function() {
                                                const checkbox = document.querySelector('input[name="is_active"]');
                                                const container = checkbox.closest('.enhanced-checkbox');
                                                if (checkbox && container) {
                                                    // Add change event
                                                    checkbox.addEventListener('change', function() {
                                                        const status = container.querySelector('.checkbox-status');
                                                        const statusText = container.querySelector('.status-text');
                                                        if (this.checked) {
                                                            container.classList.add('active');
                                                            container.classList.remove('inactive');
                                                            if (status) status.style.backgroundColor = '#007bff';
                                                            if (statusText) {
                                                                statusText.textContent = 'Active';
                                                                statusText.style.backgroundColor = '#007bff';
                                                            }
                                                        } else {
                                                            container.classList.remove('active');
                                                            container.classList.add('inactive');
                                                            if (status) status.style.backgroundColor = '#6c757d';
                                                            if (statusText) {
                                                                statusText.textContent = 'Inactive';
                                                                statusText.style.backgroundColor = '#6c757d';
                                                            }
                                                        }
                                                    });
                                                    // Trigger initial state
                                                    checkbox.dispatchEvent(new Event('change'));
                                                }
                                            })();
                                        </script>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="enhanced-checkbox admin-compact">
                                            {{ form.is_featured }}
                                            <label for="{{ form.is_featured.id_for_label }}" class="tw-font-medium tw-text-gray-700">
                                                Featured Timetable
                                                <span class="checkbox-status"></span>
                                                <span class="status-text">{{ form.is_featured.value|yesno:"Active,Inactive" }}</span>
                                            </label>
                                        </div>
                                        <div class="form-text tw-text-gray-500">Mark as featured timetable</div>
                                        <script>
                                            // Immediate initialization for this checkbox
                                            (function() {
                                                const checkbox = document.querySelector('input[name="is_featured"]');
                                                const container = checkbox.closest('.enhanced-checkbox');
                                                if (checkbox && container) {
                                                    // Add change event
                                                    checkbox.addEventListener('change', function() {
                                                        const status = container.querySelector('.checkbox-status');
                                                        const statusText = container.querySelector('.status-text');
                                                        if (this.checked) {
                                                            container.classList.add('active');
                                                            container.classList.remove('inactive');
                                                            if (status) status.style.backgroundColor = '#007bff';
                                                            if (statusText) {
                                                                statusText.textContent = 'Active';
                                                                statusText.style.backgroundColor = '#007bff';
                                                            }
                                                        } else {
                                                            container.classList.remove('active');
                                                            container.classList.add('inactive');
                                                            if (status) status.style.backgroundColor = '#6c757d';
                                                            if (statusText) {
                                                                statusText.textContent = 'Inactive';
                                                                statusText.style.backgroundColor = '#6c757d';
                                                            }
                                                        }
                                                    });
                                                    // Trigger initial state
                                                    checkbox.dispatchEvent(new Event('change'));
                                                }
                                            })();
                                        </script>
                                    </div>
                                </div>
                            </div>

                            <!-- Form Actions -->
                            <div class="tw-flex tw-flex-wrap tw-justify-between tw-items-center tw-pt-6 tw-border-t tw-border-gray-200">
                                <div>
                                    <a href="{% url 'college_website:exam_timetable_manage' %}" class="btn btn-outline-secondary tw-rounded-full tw-px-6 tw-py-2">
                                        <i class="fas fa-times tw-mr-2"></i>Cancel
                                    </a>
                                </div>
                                <div class="tw-flex tw-gap-3">
                                    {% if timetable %}
                                        <a href="{% url 'college_website:exam_timetable_week_manage' timetable.id %}" class="btn btn-info tw-rounded-full tw-px-6 tw-py-2">
                                            <i class="fas fa-calendar-week tw-mr-2"></i>Manage Weeks
                                        </a>
                                    {% endif %}
                                    <button type="submit" class="btn btn-primary tw-rounded-full tw-px-8 tw-py-2">
                                        <i class="fas fa-save tw-mr-2"></i>{{ action }} Timetable
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Preview Section -->
{% if timetable %}
<section class="preview-section tw-py-8 tw-bg-gray-50">
    <div class="container">
        <div class="row tw-justify-center">
            <div class="col-lg-10">
                <div class="tw-bg-white tw-rounded-xl tw-shadow-sm tw-p-6">
                    <h3 class="tw-text-xl tw-font-bold tw-text-gray-800 tw-mb-4">Quick Preview</h3>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="tw-bg-gray-50 tw-rounded-lg tw-p-4">
                                <h5 class="tw-font-semibold tw-text-gray-800 tw-mb-2">Current Status</h5>
                                <div class="tw-space-y-2">
                                    <div class="tw-flex tw-justify-between">
                                        <span class="tw-text-gray-600">Active:</span>
                                        <span class="badge {% if timetable.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                            {{ timetable.is_active|yesno:"Yes,No" }}
                                        </span>
                                    </div>
                                    <div class="tw-flex tw-justify-between">
                                        <span class="tw-text-gray-600">Featured:</span>
                                        <span class="badge {% if timetable.is_featured %}bg-warning{% else %}bg-secondary{% endif %}">
                                            {{ timetable.is_featured|yesno:"Yes,No" }}
                                        </span>
                                    </div>
                                    <div class="tw-flex tw-justify-between">
                                        <span class="tw-text-gray-600">Weeks:</span>
                                        <span class="tw-font-medium">{{ timetable.get_week_count }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="tw-bg-gray-50 tw-rounded-lg tw-p-4">
                                <h5 class="tw-font-semibold tw-text-gray-800 tw-mb-2">Session Times</h5>
                                <div class="tw-space-y-2">
                                    <div class="tw-flex tw-justify-between">
                                        <span class="tw-text-gray-600">Morning:</span>
                                        <span class="tw-font-medium">{{ timetable.morning_session_start|time:"g:i A" }} - {{ timetable.morning_session_end|time:"g:i A" }}</span>
                                    </div>
                                    <div class="tw-flex tw-justify-between">
                                        <span class="tw-text-gray-600">Afternoon:</span>
                                        <span class="tw-font-medium">{{ timetable.afternoon_session_start|time:"g:i A" }} - {{ timetable.afternoon_session_end|time:"g:i A" }}</span>
                                    </div>
                                    <div class="tw-flex tw-justify-between">
                                        <span class="tw-text-gray-600">Break:</span>
                                        <span class="tw-font-medium">{{ timetable.break_duration }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'admin/css/menu_admin.css' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'admin/js/enhanced-checkboxes.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Color picker preview
    const colorInputs = document.querySelectorAll('input[type="color"]');
    colorInputs.forEach(input => {
        input.addEventListener('change', function() {
            // You can add live preview functionality here
            console.log('Color changed:', this.name, this.value);
        });
    });
    
    // Form validation
    const form = document.querySelector('.needs-validation');
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    });
    
    // Initialize enhanced checkboxes
    if (typeof initEnhancedCheckboxes === 'function') {
        initEnhancedCheckboxes();
    }
    
    // Manual initialization for existing checkboxes
    setTimeout(function() {
        const checkboxes = document.querySelectorAll('.enhanced-checkbox input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            if (!checkbox.hasAttribute('data-enhanced-initialized')) {
                const container = checkbox.closest('.enhanced-checkbox');
                if (container) {
                    // Trigger change event to update styling
                    checkbox.dispatchEvent(new Event('change'));
                }
            }
        });
    }, 200);
});
</script>
{% endblock %}
